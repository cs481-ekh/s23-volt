<!DOCTYPE html>
<html lang="en">
    <title>
        Crown Joules
    </title>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" crossorigin="anonymous">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <link href="styles.css" rel="stylesheet">
    </head>
    <body>
        <div id="grid-container">
            
            <div id="main-canvas">
                <div id="save-load">
                    <h4>SIMULATION SAVE/LOAD</h4>
                    <input id="load-sim" type="file" style="visibility: hidden;"/><label for="load-sim" class="btn btn-primary">Upload</label>  <button id="save-button" class="btn btn-primary" onclick="saveCurrentState('simulation.json')">Save</button>                     
                </div> 
                <!-- below objects are for testing, will be changed/removed later -->
                <!-- <div class="cube dragtest" style="background-color:rgb(128, 255, 43)"></div> -->
                <!-- <div class="cube pathtest" style="background-color: rgb(204, 127, 255)"></div> -->
                <div class="circle" id="maincircle">
                    <canvas id="can"></canvas>
                    <div class="circlecenter" id="circlecenter"></div>
                </div>
            </div>
            
            <div id="playback-controls">
                <h3>PLAYBACK CONTROLS</h3>
                <div id="playback-grid">
                    <span>    
                        <div>
                            <button id="play-pause">Play</button>
                        </div>
                        <div>
                            <button id="step-back" onclick="stepForward(true)">&lt&lt</button>
                        </div>
                        <div>                            
                            <button id="step-forward" onclick="stepForward(false)">&gt&gt</button>
                        </div>
                    </span>
                    <div id="speed-slider">
                        <label for="playback-speed">Playback Speed:</label>
                        <input type="range" min="1" max="10" value="5" class="slider" id="playback-speed">
                    </div>
                </div>
            </div>
            
            <div id="object-menu">
                <h3>OBJECT MENU</h3>
                <table id="objects-table">
                    <tr>
                        <td>
                            
                            <div class="text-center">
                                <h4>Objects</h3>
                                <button type="button" id="add-object-button" class="btn btn-success" onclick="addObjectButton()">Add</button>
                                
                                <button type="button" id="remove-object-button" class="btn btn-danger" onclick="removeObjectButton()">Remove</button>
                             </div>
                        </td>
                        <td>

                        </td>
                    </tr>
                </table>
                <button type="button" id="init-cubes-button" class="btn btn-primary" onclick="initFirstFrame()">Draw Cubes</button>
            </div>
            
            <div id="frame-controls">
                
				<table id="frames-table">
					<tr>
						<tfoot>
							<button style="margin:2px;" id="add-frame-button" onclick="addFrameButton()">+</button>
							<label id="add-frame-button-label" for="add-frame-button">Add Frame&nbsp;</label>
							<button style="margin:2px;" id="remove-frame-button" onclick="removeFrameButton()">-</button>
							<label id="remove-frame-button-label" for="remove-frame-button">Remove Frame</label>
							<button style="margin:2px;" id="hide-frame-controls-button" onclick="hideFrameControls()">Hide Frame Controls</button>
							<button style="margin:2px;" id="graph-control-button" onclick="showGraphButton()">Show Graph</button>
						</tfoot>
					</tr>
				</table>
			</div>
        </div>  

        <div id="context-menu">
            <div class="item" id="kin-item">
                <i class="fa kin"></i> Kinetic
            </div>
            <div class="item" id="therm-item">
                <i class="fa grav"></i> Thermal
            </div>
            <div class="item" id="grav-item">
                <i class="fa kin"></i> Gravitational
            </div>
            <div class="item" id="chem-item">
                <i class="fa pot"></i> Chemical
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/Draggable.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/MotionPathPlugin.min.js"></script>

        <script>
            // START TEST DATA
            var objects = [
                {
                    name: "hand",
                    startingRad: 0,
                    endingRad: Math.PI / 2
                },
                {
                    name: "floor",
                    startingRad: Math.PI / 2,
                    endingRad: Math.PI
                },
                {
                    name: "ball",
                    startingRad: Math.PI,
                    endingRad: (3*Math.PI)/2
                },
                {
                    name: "air",
                    startingRad: (3*Math.PI)/2,
                    endingRad: 2*Math.PI
                },
            ]

            var frames = [
                {
                    1: {
                        "type": "chemical",
                        "radians": 1,
                        "radius": 0.5,
                        "color": "blue",
                        "label": "CPE",
                        "edited": false,
                        "object": 0
                    },
                    2: {
                        "type": "kinetic",
                        "radians": 2.3,
                        "radius": 0.5,
                        "color": "green",
                        "label": "KE",
                        "edited": false,
                        "object": 1
                    },
                    3: {
                        "type": "gravitational",
                        "radians": 3.9,
                        "radius": 0.5,
                        "color": "yellow",
                        "label": "GPE",
                        "edited": false,
                        "object": 2
                    },
                    4: {
                        "type": "heat",
                        "radians": 5.7,
                        "radius": 0.5,
                        "color": "red",
                        "label": "HE",
                        "edited": false,
                        "object": 3
                    },
                    5: {
                        "type": "kinetic",
                        "radians": 2,
                        "radius": 0.3,
                        "color": "green",
                        "label": "KE",
                        "edited": false,
                        "object": 1
                    }
                }
            ]
            // END TEST DATA


            //Defining templates for frame data
            var objectDataTemplate = {
                name: "",
                startingRad: 0,
                endingRad: 0
            };

            var energyCubeDataTemplate = {
                "type": "",
                "radians": 0,
                "radius": 0,
                "color": "",
                "label": "",
                "edited": false,
                "object": 0
            };

            var frameStateTemplate = {};

            var objectData = [];
            var frameData = [{}];
            var frame = 0;
            
            var intervalTimer; //= setInterval(playback, milliseconds);

            var nextObjectID = 0; // keeps track of the last object id assigned

            var table = document.getElementById("objects-table");
            var tableSize;

            var playbackActive = false;
            var playbackSpeed = 5000;

            var numObjectButtons = 0;
            var objectExpandButton = [20];
            var expand = [20];
            var zeroObjects = true;
            var energySpinnerIndexes = [10];
            var menuIsOpen = false; 
            var isInit = false;

            var playPauseButton = document.getElementById("play-pause");
            var speedSlider = document.getElementById("playback-speed");
            speedSlider.addEventListener("change", speedChanged);
            playPauseButton.addEventListener("click", playPause);



		      	addFrameButton(); //add initial frame button
	      		var graphClicked = 0;

            // create canvas, set to fill main circle
            var canvas = document.getElementById('can'),
                context = canvas.getContext('2d');
            canvas.addEventListener('click', function(e) {
                calculateQuadrant(canvas, e)
            })
            canvas.style.width='100%';
            canvas.style.height='100%';
            canvas.width  = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            //handles uploading a simulation to be displayed
            function onUploadSim(event) {
                //creating new reader and assigning a callback
                var reader = new FileReader();
                reader.onload = onReaderLoad;
                reader.readAsText(event.target.files[0]);
            }

            //once our file is uploaded, we convert it to a usable structure here
            function onReaderLoad(event){
                console.log(event.target.result);
                var obj = JSON.parse(event.target.result);
                frameData = obj;
                //resetting frame to 0 and drawing
                frame = 0;
                clearFrames();
                for(var i =0; i < frameData.length; i++){
                    addFrameButton(true); //handles from load so we don't add new frames to the data side.
                };
                drawFrame(frame);
            }
            
            document.getElementById('load-sim').addEventListener('change', onUploadSim);


            function saveCurrentState (filename) {
                const blob = new Blob([JSON.stringify(frameData)], { type: "text/json" });
                const link = document.createElement("a");

                link.download = filename;
                link.href = window.URL.createObjectURL(blob);
                link.dataset.downloadurl = ["text/json", link.download, link.href].join(":");

                const evt = new MouseEvent("click", {
                    view: window,
                    bubbles: true,
                    cancelable: true,
                });

                link.dispatchEvent(evt);
                link.remove()
            };

            // method to redraw separating lines in circle
            function divideCircle() {
                context.clearRect(0, 0, canvas.width, canvas.height);
                var numObjects = nextObjectID;
                var radius = (canvas.width)/2;
                var slice = Math.PI * (2/numObjects);
                if(numObjects == 1) {
                    return;
                }
                context.beginPath();
                context.moveTo(radius, radius);
                for(let i = 0; i<numObjects; i++) {
                    objectData[i].startingRad = i*slice;
                    objectData[i].endingRad = (i+1)*slice;
                    var x = radius + (radius * Math.sin(i*slice));
                    var y = radius + (radius * Math.cos(i*slice));
                    context.lineTo(x, y);
                    context.lineTo(radius, radius);
                }
                context.stroke();
                
            }

            //method to redraw lines based on one less object


            function polarToObjectRadians(radians) {
                if(radians >= 0) {
                    return ((3 * Math.PI) / 2) - radians;
                }
                if (radians <= 0-(Math.PI / 2)) {
                    return (radians * (-1)) - Math.PI / 2;
                }
                return (radians * (-1)) + (3 * Math.PI) / 2;
            }

            function objectToPolarRadians(radians) {
                if(radians >= Math.PI / 2 && radians <= (3 * Math.PI) / 2) {
                    return (3 * Math.PI) / 2 - radians;
                }
                if (radians <= Math.PI / 2) {
                    return (radians + Math.PI / 2) * (-1);
                }
                return (radians - (3 * Math.PI) / 2) * (-1);
            }

            function calculateQuadrant(canvas, event) {
                const numObjects = nextObjectID;
                const slice = (2*Math.PI) / numObjects;
                const rect = canvas.getBoundingClientRect()
                const relx = (event.clientX - rect.left);
                const rely = (event.clientY - rect.top);
                const x = relx - (canvas.width)/2;
                const y = (rely - (canvas.height)/2) * -1;
                const polarDistance = Math.sqrt(x*x + y*y);
                const polarRadians = Math.atan2(y,x);
                const objRadians = polarToObjectRadians(polarRadians);
                const obj = Math.trunc(objRadians/((2 * Math.PI)/numObjects));
                console.log("objRadians = " + objRadians + ", obj = " + obj);
            }
            
            function getOffset(el) {
                const rect = el.getBoundingClientRect();
                return {
                    left: rect.left + window.scrollX,
                    top: rect.top + window.scrollY
                };
            }
            var centerx = getOffset( document.getElementById('circlecenter') ).left;
            var centery = getOffset( document.getElementById('circlecenter') ).top;
            var clipper = clipAtRadius((canvas.width)/2, 0, 0);
            // TODO: fix this
            function clipAtRadius(radius, offsetX, offsetY) {
                return point => {
                    let x = centerx - offsetX,
                        y = centery - offsetY,
                        length = Math.sqrt(x * x + y * y),
                        angle;
                    if (length > radius) {
                    angle = Math.atan2(y, x);
                    centerx = radius * Math.cos(angle);
                    centery = radius * Math.sin(angle);
                    }
                    return point;
                };
            }
            
            //add object with given data
            function addObject(name) {
                var newObj = JSON.parse(JSON.stringify(objectDataTemplate)); //deep copy our static object
                newObj["name"] = name;
                objectData.push(newObj);
                nextObjectID++;
                divideCircle();
                // console.log(objectData);
            }


            //Adds energy cube to existing frame state
            function addEnergyCube(type, objectKey){
                var owner = objectData[objectKey];
                var newCube = JSON.parse(JSON.stringify(energyCubeDataTemplate));
                var loc = getRandomLocation(objectKey);
                if (owner){
                    newCube["object"] = objectKey;
                    newCube["type"] = type;
                    newCube["radians"] = loc["radians"];
                    newCube["radius"] = loc["radius"];
                    // newCube["label"] = typeAttributes["type"]["label"];
                    // newCube["color"] = typeAttributes["type"]["color"];
                    newKey = Object.keys(frameData[0]).length;
                    frameData[0][newKey] = newCube;
                    // console.log("added cube to object"+objectKey+" at loc "+newCube["radians"]+", "+newCube["radius"]);
                } else {
                    // console.log("Error: energy assigned to object "+objectKey+" which was not found");
                }
            }

            function getRandomLocation(objectNum) {
                var min = objectData[objectNum]["startingRad"] + 0.2;
                var max = objectData[objectNum]["endingRad"] - 0.2;
                var radians = Math.random() * (max - min) + min;
                var radius = Math.random() * (0.8) + 0.1;
                // console.log("getting random loc between "+min+" and "+max+" for obj "+objectNum);
                return {"radius": radius, "radians": radians}
            }

            // takes the current form values and uses them to populate the objectData and frameData structures
            function initFirstFrame() {
                var objNameBoxes = document.getElementsByClassName("obj_name_box");
                const objNameBoxArray = Array.prototype.slice.call(objNameBoxes);
                var curCount = 0;
                objNameBoxArray.forEach(nameBox => {
                    nextObjectID = nameBox.id;
                    var nextObjectIndex = parseInt(nextObjectID.charAt(nextObjectID.length - 1));
                    var nextObjectName = nameBox.value;
                    objectData[nextObjectIndex].name = nextObjectName;
                });

                frameData = [{}];
                var typeSelectors = document.getElementsByClassName("energy-type");
                const typeSelectorArray = Array.prototype.slice.call(typeSelectors);
                // console.log(typeSelectorArray);
                curCount = 0;
                typeSelectorArray.forEach(typeSelect => {
                    var typeToAdd = $(typeSelectors[curCount]).find(":selected").val();
                    // console.log(typeToAdd);
                    var parentTableID = $(typeSelect).closest('table').attr('id');
                    // console.log(typeSelect);
                    var adjacentSpinner = $(typeSelect).next();
                    var countToAdd = adjacentSpinner.val();
                    // console.log(countToAdd);
                    var owningObject = parseInt(parentTableID.charAt(parentTableID.length - 1));
                    for (let i = 0; i < countToAdd; i++) {
                        // console.log("at 442, i="+i+", owningObject="+owningObject+", typeToAdd="+typeToAdd);
                        addEnergyCube(typeToAdd, owningObject);
                    }
                    curCount++;
                });
                console.log(frameData[0]);
                drawCubes();
                updateCubeSize();
            }

            function drawCubes() {
                $( ".cube" ).remove();
                var appendstr = "";
                var count = 0;

                // console.log(frameData);
                //get our current frame
                var currentFrame = frameData[frame-1];
                console.log(currentFrame); //to show that frames are in fact moving forward
                var currentFrameKeys = Object.keys(currentFrame); //get all cube id's for the current frame
                
                currentFrameKeys.forEach(cubeID => {
                    var cube = currentFrame[cubeID]; //gets specific cube from dictionary, based on cube's id
                    appendStr = "";
                    // TODO: test enabling code, remove later
                    // var loc = getRandomLocation(cube["object"]);
                    // cube["radians"] = loc["radians"];
                    // cube["radius"] = loc["radius"];
                    // end test code
                    var nextRadians = (2 * Math.PI) - cube["radians"];
                    var nextRadius = cube["radius"] * ((canvas.width)/2);
                    var relx = nextRadius * Math.sin(nextRadians);
                    var rely = nextRadius * Math.cos(nextRadians);
                    var x = relx + (canvas.width)/2;
                    var y = rely + (canvas.height)/2;

                    switch (cube["type"]) {
                        case 'kinetic': 
                            cube["label"] = "KE";
                            cube["color"] = "lightblue";
                            break;

                        case 'thermal': 
                            cube["label"] = "TE";
                            cube["color"] = "pink";
                            break;

                        case 'gravitational': 
                            cube["label"] = "GE";
                            cube["color"] = "lightgreen";
                            break;

                        case 'chemical': 
                            cube["label"] = "CE";
                            cube["color"] = "yellow";
                            break;

                        default: 
                            cube["label"] = "Unknown";
                    }

                    appendstr = "<div id=\"cube"+count+"\" class=cube style=\"top: "+y+"px; left: "+x+"px; opacity: 50%; background-color: "+cube["color"]+";\">"+cube["label"]+"</div>";
                    
                    $( "#maincircle" ).append( appendstr );

                    document.getElementById("cube" + count).addEventListener("contextmenu", function(e){
                        if(frameData.length > 1){
                            var tableSize = (document.getElementById("frames-table").rows[0].cells.length) - 1;
                            e.preventDefault();
                            if(tableSize < 1){
                                //Can't change energy type while on initialization frame
                            }
                            else{
                                var contexElement = document.getElementById("context-menu");
                                contexElement.classList.add("active");
                                menuIsOpen = true;
                                var contexElement = document.getElementById("context-menu");
                                contexElement.style.top = e.clientY + "px";
                                contexElement.style.left = e.clientX + "px";
                            }
                        }
                    });

                    
                    document.getElementById("cube" + count).addEventListener("mouseout", function(e){
                        if(frameData.length > 1){
                            e.preventDefault();
                            var currentFrame = frameData[frame-1];
                            var targ = e.target;
                            var cubeIndex = 0;
                            var cubeList = document.getElementsByClassName("cube");
                            const cubeArray = Array.prototype.slice.call(cubeList);

                            cubeArray.every(cube => {
                                //TODO: UPDATE COORDS AFTER CUBE IS MOVED
                                var rect = cube.getBoundingClientRect();
                                var rectLeft = rect.left;
                                var rectRight = rect.right;
                                var rectTop = rect.top;
                                var rectBottom = rect.bottom;
                                if(e.clientX >= rectLeft  && e.clientX <= rectRight){
                                    if(e.clientY >= rectTop && e.clientY <= rectBottom){
                                        currentFrame[cubeIndex]["object"] = calculateQuadrant(canvas, e);
                                        return false;
                                    }
                                }
                                cubeIndex++;
                                return true;
                            });
                        }
                    });
                    count++;  
                });
                initMoveableCubes();
                Draggable.create(".cube", {
                    /*liveSnap:{
                        points: clipper
                    },*/
                    bounds: "#maincircle"
                });
                if(frameData.length == 1){
                    addDropdownListener();
                }
                
            }

            //adds a context-menu listener to each cube.
            function addDropdownListener(){
                document.getElementById("context-menu").addEventListener("mousedown", function(ev){
                    var currentFrame = frameData[frame-1];
                    var contexElement = document.getElementById("context-menu");
                    var contextTop = contexElement.offsetTop;
                    var contextLeft = contexElement.offsetLeft;
                    var targ = ev.target;
                    var cubeIndex = 0;
                    var cubeList = document.getElementsByClassName("cube");
                    const cubeArray = Array.prototype.slice.call(cubeList);

                    cubeArray.every(cube => {
                        var rect = cube.getBoundingClientRect();
                        var rectLeft = rect.left;
                        var rectRight = rect.right;
                        var rectTop = rect.top;
                        var rectBottom = rect.bottom;
                        if(contextLeft >= rectLeft && contextLeft <= rectRight){
                            if(contextTop >= rectTop && contextTop <= rectBottom){

                                switch ($(ev.target).attr("id")) {
                                    case "kin-item":
                                        menuIsOpen = false;
                                        document.getElementById("context-menu").classList.remove("active");
                                        currentFrame[cubeIndex]["type"] = "kinetic";
                                        currentFrame[cubeIndex]["label"] = "KE";
                                        currentFrame[cubeIndex]["color"] = "lightblue";
                                        drawCubes();
                                        break;
  
                                    case "therm-item":
                                        menuIsOpen = false;
                                        document.getElementById("context-menu").classList.remove("active");
                                        currentFrame[cubeIndex]["type"] = "thermal";
                                        currentFrame[cubeIndex]["label"] = "TE";
                                        currentFrame[cubeIndex]["color"] = "pink";
                                        drawCubes();
                                        break;

                                    case "grav-item":
                                        menuIsOpen = false;
                                        document.getElementById("context-menu").classList.remove("active");
                                        currentFrame[cubeIndex]["type"] = "gravitational";
                                        currentFrame[cubeIndex]["label"] = "GE";
                                        currentFrame[cubeIndex]["color"] = "lightgreen";
                                        drawCubes();
                                        break;

                                    case "chem-item":
                                        menuIsOpen = false;
                                        document.getElementById("context-menu").classList.remove("active");
                                        currentFrame[cubeIndex]["type"] = "chemical";
                                        currentFrame[cubeIndex]["label"] = "CE";
                                        currentFrame[cubeIndex]["color"] = "yellow";
                                        drawCubes();
                                        break;

                                }
                                return false;
                            }
                        }
                        cubeIndex++;
                        return true;
                    });
                    
                               
                });

            }


             //conculates which object each cube is "in"
            function initMoveableCubes(){
                var cubeList = document.getElementsByClassName("cube");
                var cubeArray = Array.prototype.slice.call(cubeList);

                for(var i = 0; i < cubeArray.length; i++){
                    var cube = document.getElementById("cube" + i);
                    cube.addEventListener("mouseup", function(e){
                        //$(e.target).attr("object") = calculateQuadrant(document.getElementById("main-canvas"), e);
                        //alert("quad changed");
                    });
                }
            }


            //hides drop-down context menu when an option is selected
            document.getElementById("context-menu").addEventListener("click", function(){
                if(menuIsOpen == true){
                    document.getElementById("context-menu").classList.remove("active");
                    menuIsOpen = false;
                }
            });

            //if canvis is clicked then menu dissapears
            window.addEventListener("mousedown", function(){
                if(menuIsOpen == true){
                    document.getElementById("context-menu").classList.remove("active");
                    menuIsOpen = false;
                }
            });

            $("head").append('<style id="style_changer" type="text/css"></style>');
            function updateCubeSize() {
                var maxHeight = (canvas.height)/30;
                if(maxHeight > 20) {
                    maxHeight = 20;
                }
                $('#style_changer').html('.cube{height:'+maxHeight+'px; width:'+maxHeight+'px;}');
            }

            window.addEventListener("resize", function() {
                context = canvas.getContext('2d');
                canvas.width  = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                var centerx = getOffset( document.getElementById('circlecenter') ).left;
                var centery = getOffset( document.getElementById('circlecenter') ).top;
                var clipper = clipAtRadius((canvas.width)/2, 0, 0);
                divideCircle();
                drawCubes();
                updateCubeSize();
            });

            //removes object based on key
            function removeObject(key) { 
                let first = frameData[0];
                if (first){
                    delete first[key];
                }
            }

            //adds new frame with previous state
            function addFrame(){
                let newFrame;
                
                if (frameData < 0){
                    newFrame = JSON.parse(JSON.stringify(frameStateTemplate)); //deep copy our frame state
                }else{
                    console.log(frameData);
                    console.log(frame);
                    newFrame = JSON.parse(JSON.stringify(frameData[frameData.length - 1])); //deep copy our frame state
                }

                frameData.push(newFrame);
                frame = frameData.length - 1;
            }
            
            //removes the last frame
            function removeLastFrame(){
                frameData.pop();
                frame = frameData.length - 1;
            }

            //clamps a number to specific range
            //source : https://stackoverflow.com/questions/11409895/whats-the-most-elegant-way-to-cap-a-number-to-a-segment
            function clampNumber(number, min, max) {
                return Math.max(min, Math.min(number, max));
            }

            //handles changing playback speed
            function speedChanged(e){
                let speedVal = Number(e.target.value);

                //make sure we have a valid speed value, and that its not zero
                if (speedVal && speedVal > 0.1){
                    playbackSpeed = 25000/speedVal;
                    togglePlayback(true);
                }
            }
            
            //annimation = document.getElementById("physics-annimation");
            function playPause() { 

                if(playbackActive == true){

                    //stop playback
                    togglePlayback(false);
                }
                else{

                    //begin playback
                    togglePlayback(true);
                }
            } 

            //walks through existing frames, stops at end
            function playback(){
                if (frame < frames.length - 1){
                    stepForward();
                }else{
                    togglePlayback(false);
                }
            }

            //toggles interval that steps through frames
            function togglePlayback(start){
                if(start === true){
                    if (frame >= frameData.length - 1){
                        frame = 0;
                    }
                    //handles starting current playback
                    playPauseButton.innerHTML = "Pause";

                    //stop the current playback interval, then restart it
                    clearInterval(intervalTimer);
                    intervalTimer = setInterval(playback, playbackSpeed);
                    playbackActive = true;
                }else{
                    //handles pausing current playback
                    playPauseButton.innerHTML = "Play";

                    clearInterval(intervalTimer);
                    playbackActive = false;
                }
            }

            //updates the current cubes and states to render properly on the canvas
            function drawFrame(toFrame){
                frame = toFrame;
                drawCubes();
            }

            //allows us to step forwards and backwards in our simulation (frame to frame)
            function stepForward(reverse){
                var nextFrame = 0;
                
                if (reverse) {
                    nextFrame = frame - 1;
                }else{
                    nextFrame = frame + 1;
                }

                //make sure our target frame is in range of our actual frame data
                clampNumber(nextFrame,0,frameData.length);
                drawFrame(nextFrame);
            }

            function addObjectButton(){
                numObjectButtons++;
                var currentIndex = numObjectButtons - 1;
                expand[currentIndex] = 0;
                
                // addEntity

                tableSize = document.getElementById("objects-table").rows.length;

                var newRow = table.insertRow(tableSize);
                var newCell1 = newRow.insertCell(0);

                var tableSize = document.getElementById("objects-table").rows.length;
                document.getElementById("objects-table").deleteRow(tableSize - 1);

                var newRow = table.insertRow(tableSize - 2);
                var newCell1 = newRow.insertCell(0);
                newCell1.innerHTML = createNewObject(nextObjectID);
                
                //Adds object and increments nextObjectID
                addObject("tmp");

            }

            function removeObjectButton(){
                if(numObjectButtons == 0){
                    return;
                }
                numObjectButtons--;
                var currentIndex = numObjectButtons - 1;
                expand[currentIndex] = 0;
                
                var tableSize = document.getElementById("objects-table").rows.length;
                document.getElementById("objects-table").deleteRow(tableSize - 2);
                nextObjectID--;
                divideCircle();
            }

            //Adds another energy type to an object
            function addEnergy(i){
                if(energySpinnerIndexes[i] == 3){
                    return;
                }
                energySpinnerIndexes[i]++;
                var energyTable = document.getElementById("energy-table" + i);
                var energyTableSize = document.getElementById("energy-table" + i).rows.length;
                var newRow = energyTable.insertRow(energyTableSize);
                var newCellContent = "<select name=\"energy-names\" class=\"energy-type\" id=\"energy-type\" text-align=\"center\">";
                newCellContent = newCellContent + "<option hidden=\"\">Energy Type</option><option value=\"kinetic\">Kinetic</option><option value=\"thermal\">Thermal</option><option value=\"gravitational\">Gravitational</option><option value=\"chemical\">Chemical</option></select>";
                newCellContent = newCellContent + "<input placeholder=\"Number\" required type=\"number\" value=\"\" min=\"0\" max=\"10\"/ id=\"energy-spin" + energySpinnerIndexes[i] + "\"></div>";
                var newCell = newRow.insertCell(0);
                newCell.innerHTML = newCellContent;
            }

            function removeEnergy(i){
                if(energySpinnerIndexes[i] == 0){
                    return;
                }
                energySpinnerIndexes[i]--;
                var energyTable = document.getElementById("energy-table" + i);
                var energyTableSize = document.getElementById("energy-table" + i).rows.length;
                energyTable.deleteRow(energyTableSize - 1);


            }

            function createNewObject(objID){
                var returnString;
                var currentIndex = numObjectButtons - 1;
                returnString = "<input type=\"text\" class=\"obj_name_box\" id=\"object" + currentIndex + "\" placeholder=\"Object Name\"></input> ";
                returnString = returnString + "<div class=\"text-right\"><button id=\"expand" + currentIndex + "\" class=\"btn btn-primary\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseExample" + currentIndex + "\" aria-expanded=\"false\" aria-controls=\"collapseExample\" >Expand</button></div>";
                returnString = returnString + "<div class=\"collapse\" id=\"collapseExample" + currentIndex + "\"><div class=\"card card-body\">" + newEnergyMenu(objID) + "</div></div>";
                return returnString;
            }

            function newEnergyMenu(objID){
                var returnString;
                var currentIndex = numObjectButtons - 1;
                energySpinnerIndexes[currentIndex] = 0;

                returnString = "<div id=\"energy-menu\" align=\"center\"><table id=\"energy-table" + currentIndex + "\"><tr><td>";
                returnString = returnString + "<select name=\"energy-names\" class=\"energy-type\" id=\"energy-type\" text-align=\"center\">";
                returnString = returnString + "<option hidden=\"\">Energy Type</option><option value=\"kinetic\">Kinetic</option><option value=\"thermal\">Thermal</option><option value=\"gravitational\">Gravitational</option><option value=\"chemical\">Chemical</option></select>";
                returnString = returnString + "<input placeholder=\"Number\" required type=\"number\" value=\"\" min=\"0\" max=\"10\"/ id=\"energy-spin" + energySpinnerIndexes[currentIndex] + "\"></div>"
                returnString = returnString + "</td><td></td></tr></table>";
                returnString = returnString + "<br><div align=\"center\"><h5>Energy</h5><button id=\"add-energy-button\" class=\"btn btn-success\" onclick=\"addEnergy(" + currentIndex + ")\">Add</button>\ <button id=\"remove-energy-button\" class=\"btn btn-danger\" height=\"2px\" onclick=\"removeEnergy(" + currentIndex + ")\">Remove</button></div>";

                return returnString;
            }

            //$("input[type='number']").inputSpinner();

            //clears out visual frames so we can refresh for data
            function clearFrames(){
                var table = document.getElementById("frames-table");
                for (var j = 0; j < table.rows[0].cells.length; j++) {
                    table.rows[0].deleteCell(j);
                }
                table.rows[0].innerHTML = "";
            }

			function addFrameButton(fromLoad = false) {
                var table = document.getElementById("frames-table");
                var tableSize = document.getElementById("frames-table").rows[0].cells.length;
                var newCol = table.rows[0].insertCell(tableSize);
                var tableSize = document.getElementById("frames-table").rows[0].cells.length;
				        newCol.innerHTML = "<button id=\"select-frame-button\" onclick=\"selectFrameButton(" + tableSize + ")\">" + (tableSize) + "</button>"; //make do something later
                //hides Object menu and displays playback menu if more than one frame is added
                if(tableSize == 1){
                    document.getElementById("object-menu").style.display = "block";
                }
                if(tableSize >= 2){
                    document.getElementById("object-menu").style.display = "none";
                    document.getElementById("playback-controls").style.display = "block";
                }
                if (fromLoad === false){
                    addFrame();
                }
            }
			
			function removeFrameButton() {
				var table = document.getElementById("frames-table");
				var tableSize = (document.getElementById("frames-table").rows[0].cells.length) - 1;
				if (tableSize === 0) {
					//do nothing
				} else {
				var delCol = table.rows[0].deleteCell(tableSize);
                //hides playback menu and displays object menu if only one frame exists
                    if(tableSize == 1){
                        document.getElementById("object-menu").style.display = "block";
                        document.getElementById("playback-controls").style.display = "none";
                    }
                    //hides main canvas, playback controls, and object menu when no frames exist
                    if(tableSize < 1){
                        document.getElementById("object-menu").style.display = "none";
                        document.getElementById("playback-controls").style.display = "none";
                    }
				}
			}

			
			
			function hideFrameControls() {
				if (document.getElementById("frames-table").style.display === "none") { // if not showing, show all frame controls
					document.getElementById("frames-table").style.display="flex"; //show using flex, the old preset
					document.getElementById("hide-frame-controls-button").innerHTML = "Hide Frame Controls"; //change text
					document.getElementById("add-frame-button").style.display="inline-block";
					document.getElementById("add-frame-button-label").innerHTML = "Add Frame&nbsp;";
					document.getElementById("remove-frame-button").style.display="inline-block";
					document.getElementById("remove-frame-button-label").innerHTML = "Remove Frame";
				} else { // if showing, hide all frame controls
					document.getElementById("frames-table").style.display="none"; //hide
					document.getElementById("hide-frame-controls-button").innerHTML = "Show Frame Controls"; //change text
					document.getElementById("add-frame-button").style.display="none";
					document.getElementById("add-frame-button-label").innerHTML = "";
					document.getElementById("remove-frame-button").style.display="none";
					document.getElementById("remove-frame-button-label").innerHTML = "";
				}
			}
			

			function showGraphButton() {
				if (graphClicked === 0) {
					//add some graph stuff here
					document.getElementById("graph-control-button").innerHTML = "Hide Graph";
					graphClicked = 1;
				} else {
					document.getElementById("graph-control-button").innerHTML = "Show Graph";
					//add some graph stuff here, but different
					graphClicked = 0;
				}
			}
			
			function selectFrameButton(i) {
                frame = i - 1;
                togglePlayback(false);
				drawCubes(); //should grab frame data, doesnt display yet
			}
		
        </script>
        
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    </body>
</html>